<template><div class='card' :style='{padding:"8px"}'><div ref='host' style='width:100%;height:280px;border:1px solid #1d2036;border-radius:12px;background:#0f1324'><svg ref='svg' width='100%' height='100%'></svg></div><div class='small' style='margin-top:6px'><a :href="`/api/image/${specId}.png`" target='_blank'>PNG</a> Â· <a :href="`/api/image/${specId}.svg`" target='_blank'>SVG</a></div></div></template><script setup lang='ts'>import * as d3 from 'd3'; import { onMounted, ref } from 'vue'; const props=defineProps<{specId:string}>(); const host=ref(null as any); const svgRef=ref(null as any); async function j(u:string){ const r=await fetch(u); if(!r.ok) throw new Error(await r.text()); return await r.json() } function clear(g:any){ g.selectAll('*').remove() } function line(g:any,sp:any,data:any[],W:number,H:number){ clear(g); const x=d3.scaleUtc().domain(d3.extent(data,(d:any)=>new Date(d[sp.x.field])) as any).range([0,W-60]); const y=d3.scaleLinear().domain(d3.extent(data,(d:any)=>d[sp.y.field]) as any).nice().range([H-50,0]); g.append('g').attr('transform',`translate(0,${H-50})`).call(d3.axisBottom(x).ticks(5)); g.append('g').call(d3.axisLeft(y).ticks(4)); const L=d3.line<any>().x((d:any)=>x(new Date(d[sp.x.field]))).y((d:any)=>y(d[sp.y.field])); g.append('path').datum(data).attr('fill','none').attr('stroke','#4ea0ff').attr('stroke-width',2).attr('d',L as any) } function bar(g:any,sp:any,data:any[],W:number,H:number){ clear(g); const x=d3.scaleBand<string>().domain(data.map((d:any)=>d[sp.x.field])).range([0,W-60]).padding(0.2); const y=d3.scaleLinear().domain([0,d3.max(data,(d:any)=>d[sp.y.field])||1]).nice().range([H-50,0]); g.append('g').attr('transform',`translate(0,${H-50})`).call(d3.axisBottom(x)); g.append('g').call(d3.axisLeft(y).ticks(4)); g.selectAll('.bar').data(data).join('rect').attr('class','bar').attr('x',(d:any)=>x(d[sp.x.field])!).attr('y',(d:any)=>y(d[sp.y.field])).attr('width',x.bandwidth()).attr('height',(d:any)=>(H-50)-y(d[sp.y.field])) } function net(g:any,_sp:any,data:any,W:number,H:number){ clear(g); const sim=d3.forceSimulation(data.nodes).force('link',d3.forceLink(data.links).id((d:any)=>d.id).distance(40).strength(0.9)).force('charge',d3.forceManyBody().strength(-80)).force('center',d3.forceCenter((W-60)/2,(H-50)/2)); const link=g.selectAll('line').data(data.links).join('line'); const node=g.selectAll('circle').data(data.nodes).join('circle').attr('r',(d:any)=>d.weight?Math.max(4,Math.min(12,d.weight)):6).call((d3 as any).drag().on('start',s).on('drag',d).on('end',e)); const label=g.selectAll('text').data(data.nodes).join('text').text((d:any)=>d.label||d.id); sim.on('tick',()=>{link.attr('x1',(d:any)=>d.source.x).attr('y1',(d:any)=>d.source.y).attr('x2',(d:any)=>d.target.x).attr('y2',(d:any)=>d.target.y); node.attr('cx',(d:any)=>d.x).attr('cy',(d:any)=>d.y); label.attr('x',(d:any)=>d.x+8).attr('y',(d:any)=>d.y+4)}) } onMounted(async()=>{ const svg=d3.select(svgRef.value as any); const g=svg.append('g').attr('transform','translate(40,20)'); const W=(host.value?.clientWidth||800),H=280; const sp=await j(`/api/specs/${props.specId}`); const data=await j(`/api/data/${props.specId}`); if(sp.type==='line') line(g,sp,data,W,H); else if(sp.type==='bar') bar(g,sp,data,W,H); else if(sp.type==='network') net(g,sp,data,W,H) })</script>